<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MarnelleGPT</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            background-color: #f4f4f4;
            transition: background-color 0.3s ease;
            min-height: 100vh;
            padding-bottom: 60px; /*Input-area uchun joy*/
            overflow-x: hidden;
        }
        body.dark-theme {
            background-color: #333;
            color: #fff;
        }
        body.dark-theme .chat-container {
            background-color: #444;
            color: #fff;
        }
        body.dark-theme .bot-message {
            background-color: #555;
        }
        body.dark-theme .user-message {
            background-color: #666;
        }
        body.dark-theme .loading-message {
            color: #fff;
        }
        body.dark-theme .markdown-content a {
            color: #007bff;
        }
        .markdown-content a {
            color: #0000ff;
        }
        .markdown-content ul {
            margin-left: 20px;
        }
        .markdown-content ol {
            margin-left: 20px;
        }
        .markdown-content blockquote {
            border-left: 5px solid #eee;
            padding: 10px;
            margin-left: 0;
            font-style: italic;
        }
        .markdown-content pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-family: monospace;
            position: relative;
        }
        body.dark-theme .markdown-content pre{
            background-color: #363636;
            color: #fff;
        }
        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .markdown-content pre:hover .copy-button{
            opacity: 1;
        }
        body.dark-theme .copy-button{
            background-color: #222;
            color: #fff;
        }
        .loading-message{
            display: inline-block;
            text-align: left;
            margin-bottom: 0px;
        }
        .loading-message > div {
            display: inline-block;
            width: 60px;
            height: 60px;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #fff;
            border-bottom: 1px solid #ccc;
            position: fixed;
            width: 100%;
            max-width: 800px;
            top: 0;
            z-index: 1000;
            box-sizing: border-box;
        }
        body.dark-theme .top-bar{
            background-color: #444;
            border-bottom: 1px solid #555;
        }
        .top-bar img {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        .chat-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        body.dark-theme .chat-title{
            color: #fff;
        }
        .menu-icon, .edit-icon{
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drawer {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease;
            padding: 20px;
            z-index: 1001;
            visibility: hidden;

        }
        .drawer.open {
            left: 0;
            visibility: visible;
        }
        body.dark-theme .drawer {
            background-color: #333;
            color: #fff;
        }
        .drawer ul {
            list-style: none;
            padding: 0;
        }
        .drawer ul li {
            padding: 10px;
            cursor: pointer;
        }
        body.dark-theme .drawer ul li:hover{
            background-color: #444;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        .overlay.open {
            display: block;
        }
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: calc(100vh - 60px); /* Balandligi to'liq ekran, input area uchun joy */
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden;
            margin-top: 40px; /* title uchun joy */
            box-sizing: border-box;
            margin-bottom: 60px;
            position: relative;
        }
        @media (max-width: 600px) {
            .chat-container {
                border-radius: 0;
                max-width: 100%;
            }
            .top-bar {
                max-width: 100%;
            }
        }
        #chat-log {
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
            cursor: pointer;
        }
        .bot-message, .user-message {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.3s ease-out forwards;
            display: flex;
            position: relative;
        }
        .bot-message {
            background-color: #e0f7fa;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 10px;
            align-self: flex-start;
            transition: background-color 0.3s ease;
            max-width: 70%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #c8e6c9;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 10px;
            align-self: flex-end;
            transition: background-color 0.3s ease;
            max-width: 70%;
            word-wrap: break-word;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ccc;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            box-sizing: border-box;
            max-width: 800px;
            z-index: 1000;
            align-items: center;
        }
        body.dark-theme .input-area{
            background-color: #333;
        }
        .input-area .plus-button{
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background-color: #eee;
            border-radius: 50%;
            margin-right: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        body.dark-theme .input-area .plus-button{
            background-color: #444;
        }
        .input-area .plus-button svg{
            width: 16px;
            height: 16px;
            fill: #000;
        }
        body.dark-theme .input-area .plus-button svg{
            fill: #fff;
        }
         .input-area #image-preview {
             max-width: 50px;
            max-height: 50px;
            margin-right: 5px;
             border-radius: 5px;
         }
        #user-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            margin-right: 5px;
            transition: border 0.3s ease;
            font-size: 16px;
            background-color: #eee;
            outline: none;
        }
        body.dark-theme #user-input {
            border: none;
            background-color: #444;
        }
        #send-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: #000;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-left: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #send-button svg {
            fill: #fff;
            width: 20px;
            transition: transform 0.2s ease;
        }

        #send-button:hover {
            transform: scale(1.1);
        }
        body.dark-theme #send-button {
            background-color: #fff;
        }
        body.dark-theme #send-button svg {
            fill: #000;
        }
        .message-wrapper {
            position: relative; /* Tugmalar uchun pozitsion konteyner */
            display: flex; /* Tugmani matn bilan yonma-yon joylashtirish uchun */
            align-items: flex-start; /* Tugmani tepadan tekislash */
        }
        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none; /* Dastlab ko'rinmaydi */
            z-index: 1;
            background-color: rgba(255,255,255,0.8); /* fon */
            border-radius: 5px;
            padding: 5px;
        }

        body.dark-theme .message-actions{
            background-color: rgba(0,0,0,0.8);
        }
        .message-wrapper:hover .message-actions, .message-actions:hover{
            display: block;
        }
        .message-actions button{
            border: none;
            padding: 5px;
            background-color: transparent;
            cursor: pointer;
            margin-left: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        body.dark-theme .message-actions button{
            color: #fff;
        }
        .message-actions button img {
            width: 16px;
            height: 16px;
            pointer-events: none; /* ichidagi elementlar o'zini tutmasligi uchun */
        }
        .message-actions button.copied{
            animation: copiedAnimation 0.5s ease-in-out;
        }
        @keyframes copiedAnimation {
            0%{
                transform: scale(1);
            }
            50%{
                transform: scale(1.4);
            }
            100%{
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
<div class="drawer">
    <ul>
        <li id="new-chat-drawer">New Chat</li>
    </ul>
</div>
<div class="overlay"></div>
<div class="top-bar">
    <div class="menu-icon">
        <img src="icons/menu_icon.svg" alt="Menu">
    </div>
    <div class="chat-title">
        MarnelleGPT
    </div>
    <div class="edit-icon" id="new-chat-button">
        <img src="icons/edit_icon.svg" alt="Edit">
    </div>
</div>
<div class="chat-container">
    <div id="chat-log">

    </div>

</div>
<div class="input-area">
    <div class="plus-button">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
        <input type="file" id="image-input" accept="image/*" style="display:none">
    </div>
    <img src="" id="image-preview" style="display: none;">
    <input type="text" id="user-input" placeholder="Message...">
    <div id="send-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path d="M11.293 5.293a1 1 0 0 1 1.414 0l5 5a1 1 0 0 1 -1.414 1.414L13 8.414V18a1 1 0 1 1 -2 0V8.414l-3.293 3.293a1 1 0 0 1 -1.414 -1.414l5 -5Z" />
        </svg>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script>
    const chatLog = document.getElementById('chat-log');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const body = document.body;
    const menuIcon = document.querySelector('.menu-icon');
    const drawer = document.querySelector('.drawer');
    const overlay = document.querySelector('.overlay');
    const newChatButton = document.getElementById('new-chat-button');
    const newChatDrawerButton = document.getElementById('new-chat-drawer');
    const GEMINI_API_KEY = 'AIzaSyB66dpDKO1WLd5tIHvsTuVryIPXiXbEedA';
    const MODEL_NAME = "gemini-2.0-flash-exp";
    let isDarkTheme = false;
    let chatHistory = [];
    let startX = 0;
    let touchStartX = 0;
    const plusButton = document.querySelector('.input-area .plus-button');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    let  selectedImage = null;


    function toggleTheme() {
        isDarkTheme = !isDarkTheme;
        body.classList.toggle('dark-theme');
    }

    function toggleDrawer(event) {
        drawer.classList.toggle('open');
        overlay.classList.toggle('open');
        event.stopPropagation();
    }
    overlay.addEventListener('click', toggleDrawer);
    menuIcon.addEventListener('click', toggleDrawer);
    function startNewChat() {
        chatHistory = [];
        localStorage.removeItem('chatHistory');
        chatLog.innerHTML = '';
        addMessage("Hello! I'm an AI chatbot. Type your question.", "bot");
        drawer.classList.remove('open');
        overlay.classList.remove('open');
    }
    newChatButton.addEventListener('click', startNewChat);
    newChatDrawerButton.addEventListener('click', startNewChat)

    function loadChatHistory(){
        const storedHistory = localStorage.getItem('chatHistory');
        if(storedHistory){
            chatHistory = JSON.parse(storedHistory);
            chatHistory.forEach(message => {
                addMessage(message.text, message.sender, message.isImage);
            })
        }else{
            addMessage("Hello! I'm an AI chatbot. Type your question.", "bot");
        }
    }

    function saveChatHistory(){
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory.map(item => {
            if (item.isImage) {
                return { text: item.text, sender: item.sender, isImage: true, fileUri:item.fileUri };
            }
            return item;
        })));
    }

    function addLoadingMessage(isImageLoading = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('bot-message', 'loading-message');
        const loadingContainer = document.createElement('div');
        messageDiv.appendChild(loadingContainer);
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
        const animationPath = isImageLoading ? 'image_typing.json' : 'chat_typing.json';

        const animation = lottie.loadAnimation({
            container: loadingContainer,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: animationPath,
        });
        return { messageDiv, animation };
    }

    function removeLoadingMessage(loading) {
        if(loading && loading.animation){
            loading.animation.destroy();
            loading.messageDiv.remove();
        }
    }

    function addMessage(message, sender, isImage = false, fileUri = null) {
          if (!message) return;
        const messageDiv = document.createElement('div');
        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('message-wrapper');

        const contentDiv = document.createElement('div')
        contentDiv.classList.add('markdown-content');
        let html = sender === 'bot' ? marked.parse(message || '') : message;

        if(isImage && message.startsWith('data:image/')){
            html = `<img src="${message}" alt="User Image" style="max-width:100%; max-height:400px; border-radius: 10px;">`;
        }else if(isImage && message.startsWith("https") || fileUri){
            html = `<img src="${fileUri ? fileUri : message}" alt="Generated Image" style="max-width:100%; max-height:400px; border-radius: 10px;">`;
        }
        contentDiv.innerHTML = html;
        messageWrapper.appendChild(contentDiv)
        messageDiv.appendChild(messageWrapper);
        messageDiv.classList.add(sender + '-message');

        const actionsDiv = document.createElement('div');
        actionsDiv.classList.add('message-actions');


        const copyButton = document.createElement('button');
        copyButton.innerHTML = '<img src="icons/copy_icon.svg" alt="Copy" style="width: 16px; height: 16px;">';
        copyButton.addEventListener('click', (event) => {
            event.stopPropagation(); // xabar click bo'lmasligi uchun
            if(!isImage){
                navigator.clipboard.writeText(message).then(() => {
                    // copyButton.innerHTML = '<img src="icons/copied_icon.svg" alt="Copied!" style="width: 16px; height: 16px;">';
                    copyButton.classList.add('copied');
                    setTimeout(() => {
                        copyButton.innerHTML = '<img src="icons/copy_icon.svg" alt="Copy" style="width: 16px; height: 16px;">';
                        copyButton.classList.remove('copied');
                    }, 2000)
                })
                    .catch(err => {
                        console.error("Failed to copy message:", err)
                        copyButton.innerHTML = '<img src="icons/error_icon.svg" alt="Error!" style="width: 16px; height: 16px;">';
                        setTimeout(() => {
                            copyButton.innerHTML = '<img src="icons/copy_icon.svg" alt="Copy" style="width: 16px; height: 16px;">';
                        }, 2000)
                    })
            }
        });


        const editButton = document.createElement('button');
        editButton.innerHTML = '<img src="icons/edit_icon.svg" alt="Edit" style="width: 16px; height: 16px;">';

        editButton.addEventListener('click', (event) => {
            event.stopPropagation(); // xabar click bo'lmasligi uchun
            userInput.value = message;
            userInput.focus();
        });


        if(isImage){
            const downloadButton = document.createElement('button');
            downloadButton.innerHTML = '<img src="icons/download_icon.svg" alt="Download" style="width: 16px; height: 16px;">';
            downloadButton.addEventListener('click', (event) => {
                event.stopPropagation();
                const link = document.createElement('a');
                link.href = message;
                link.download = 'generated_image.jpg'; // yoki png
                link.click();
            });
            actionsDiv.appendChild(downloadButton);
        }else{
            actionsDiv.appendChild(copyButton);
            actionsDiv.appendChild(editButton);
        }
        messageWrapper.appendChild(actionsDiv);

        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;

        contentDiv.querySelectorAll('pre code').forEach(block => {
            hljs.highlightBlock(block);
        });

        contentDiv.querySelectorAll('pre').forEach(pre => {
            const copyButton = document.createElement('button');
            copyButton.textContent = 'Copy';
            copyButton.classList.add('copy-button');
            pre.appendChild(copyButton);
            copyButton.addEventListener('click', () => {
                const code = pre.querySelector('code');
                if(code){
                    navigator.clipboard.writeText(code.textContent).then(() => {
                        copyButton.textContent = 'Copied!';
                        setTimeout(() => {
                            copyButton.textContent = 'Copy';
                        }, 2000)
                    })
                        .catch(err => {
                            console.error("Failed to copy code:", err)
                            copyButton.textContent = 'Error!';
                            setTimeout(() => {
                                copyButton.textContent = 'Copy';
                            }, 2000)
                        })
                }
            })
        })
    }
    async function handleUserInput() {
      const userMessage = userInput.value.trim();
        let base64Image = null;
        let imageUri = null;
         if(selectedImage){
           let loading = addLoadingMessage(true);
            try{
                 imageUri = await uploadImage(selectedImage);
                base64Image = await convertImageToBase64(selectedImage);
                if (base64Image) addMessage(base64Image, 'user', true,  imageUri);
                 chatHistory.push({ text: base64Image, sender: "user", isImage: true, fileUri:imageUri });
            } catch (error) {
               addMessage("Failed to upload image: "+ error, "bot");
                console.log(error)
            }
          removeLoadingMessage(loading);
        }
          if (userMessage || imageUri) {
              userInput.value = '';
              let loading;
              const generateIndex = userMessage?.toLowerCase()?.indexOf("generate") ?? -1;
              const imagineIndex = userMessage?.toLowerCase()?.indexOf("imagine") ?? -1;
              const sendButtonSvg = sendButton.querySelector('svg path');
              sendButtonSvg.setAttribute('d', 'M2 12C2 6.477 6.477 2 12 2s10 4.477 10 10 -4.477 10 -10 10S2 17.523 2 12Zm7.5 -3.5a1 1 0 0 0 -1 1v5a1 1 0 0 0 1 1h5a1 1 0 0 0 1 -1v-5a1 1 0 0 0 -1 -1h-5Z');

                if (generateIndex !== -1 || imagineIndex !== -1) {
                    loading = addLoadingMessage(true);
                     try{
                            const prompt = userMessage.substring(Math.max(generateIndex,imagineIndex) + (generateIndex !== -1 ? "generate".length : "imagine".length)).trim();
                            const seed = Math.floor(Math.random() * 1000000);
                            const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?seed=${seed}`;
                            const response = await fetch(imageUrl);
                             if (!response.ok) {
                                throw new Error(`API error: ${response.status}`);
                            }
                           addMessage(imageUrl, 'bot', true);
                           chatHistory.push({ text: imageUrl, sender: "bot", isImage: true });
                             chatHistory.push({ role: "model", parts: [{ text: imageUrl }] });
                        } catch (error) {
                            addMessage("Failed to generate image: "+ error, "bot");
                        }
                       removeLoadingMessage(loading);
                       sendButtonSvg.setAttribute('d', 'M11.293 5.293a1 1 0 0 1 1.414 0l5 5a1 1 0 0 1 -1.414 1.414L13 8.414V18a1 1 0 1 1 -2 0V8.414l-3.293 3.293a1 1 0 0 1 -1.414 -1.414l5 -5Z');
                } else {
                     loading = addLoadingMessage(false);
                     let requestContents = chatHistory.filter(item => item.role);
                       let parts = [];
                      if (imageUri){
                           parts.push( {
                               fileData: {
                                    fileUri: imageUri,
                                    mimeType: 'image/jpeg'
                                   }
                             })
                        }
                       if(userMessage){
                            parts.push({
                                  text: userMessage
                              })
                               chatHistory.push({ text: userMessage, sender: "user" });
                        }
                         if (parts.length > 0) {
                            requestContents.push({ role: "user", parts: parts });
                         }
                       try {
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ contents: requestContents }),
                           });
                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(`API error: ${response.status} - ${JSON.stringify(errorData)}`);
                            }
                           const data = await response.json();
                           console.log(data);
                           try {
                                const botText = data.candidates[0].content.parts[0].text;
                                console.log(botText);
                                addMessage(botText, 'bot');
                                chatHistory.push({ text: botText, sender: "bot" });
                                chatHistory.push({ role: "model", parts: [{ text: botText }] });
                           } catch (err){
                                addMessage("The response from the AI was empty.", "bot");
                           }
                        } catch (error) {
                            addMessage("An error occurred: " + error.message, "bot");
                            console.error("Error fetching data from the API:", error);
                        }
                       removeLoadingMessage(loading);
                     sendButtonSvg.setAttribute('d', 'M11.293 5.293a1 1 0 0 1 1.414 0l5 5a1 1 0 0 1 -1.414 1.414L13 8.414V18a1 1 0 1 1 -2 0V8.414l-3.293 3.293a1 1 0 0 1 -1.414 -1.414l5 -5Z');
                }
           selectedImage = null;
          imagePreview.style.display = "none";
            imagePreview.src = "";
        }
        saveChatHistory();
    }
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                 reader.onloadend = () => {
                  resolve(reader.result);
                };
                  reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
     async function uploadImage(file) {
        const apiKey = GEMINI_API_KEY;
        const mimeType = file.type;
        const filename = `user_upload_${Date.now()}.${mimeType.split('/')[1]}`;
         try{
        const uploadUrl = `https://generativelanguage.googleapis.com/upload/v1beta/files?key=${apiKey}`;
         const arrayBuffer = await file.arrayBuffer();
          const numBytes = arrayBuffer.byteLength
        const headers = {
              'X-Goog-Upload-Command': 'start, upload, finalize',
              'X-Goog-Upload-Header-Content-Length': numBytes,
              'X-Goog-Upload-Header-Content-Type': mimeType,
              'Content-Type': 'application/json',
            };

           const uploadResponse = await fetch(uploadUrl,{
            method: 'POST',
               headers: headers,
                body:  JSON.stringify({
                   file: {
                        display_name: filename
                      }
                    }),
                 });

             if (!uploadResponse.ok) {
                 throw new Error(`File upload error: ${uploadResponse.status} - ${uploadResponse.statusText}`)
             }
           const uploadData = await uploadResponse.json();
          const uploadUri = uploadData.file.uri;
          const uploadBinaryUrl = `${uploadUrl}&upload_id=${uploadData.upload_id}`;
          const binaryResponse = await fetch(uploadBinaryUrl,{
            method: 'POST',
              headers: {
                  'X-Goog-Upload-Command': 'upload, finalize',
                    'Content-Type': 'application/octet-stream',
                },
               body:  arrayBuffer,
          })

          if (!binaryResponse.ok) {
                 throw new Error(`Binary data upload error: ${binaryResponse.status} - ${binaryResponse.statusText}`)
              }

         return uploadUri;
      } catch(error){
            console.error("Image upload failed:", error);
             throw error
        }
    }
       plusButton.addEventListener('click', () => {
            imageInput.click();
        });

        imageInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
             if(file){
                const base64Image = await convertImageToBase64(file);
                 selectedImage = file;
                  imagePreview.style.display = "block";
                imagePreview.src = base64Image;
            }
        });

    body.addEventListener('touchstart', (event) => {
        touchStartX = event.touches[0].clientX;
    });
    body.addEventListener('touchend', (event) => {
        const touchEndX = event.changedTouches[0].clientX;
        const deltaX = touchEndX - touchStartX;
        if(deltaX > 50 && !drawer.classList.contains('open')){
            toggleDrawer(event)
        }
    });
    loadChatHistory();
    sendButton.addEventListener('click', handleUserInput);
    userInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
           handleUserInput();
        }
    });
</script>
</body>
</html>
